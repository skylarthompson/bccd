#!/usr/bin/env bash

set -xeo pipefail

PATH=/bin:/usr/bin:/sbin:/usr/sbin

. /vagrant/bccd.conf

DBS_TAR="/vagrant/target/debootstrap.tar.bz2"

# Support either debootstrap-bccd or debootstrap
if [[ -z ${NO_BCCD} ]]; then
    DBS_BCCD_TAR="/vagrant/target/debootstrap-bccd.tar.bz2"
else
    DBS_BCCD_TAR="${DBS_TAR}"
fi

if [[ ! -d "${DBS_DIR}" ]]; then
    mkdir -p "${DBS_DIR}"
fi

if [[ -r "${DBS_BCCD_TAR}" ]]; then
    nice pbzip2 -dc "${DBS_BCCD_TAR}" | tar -C /vagrant -xf -
elif [[ -r "${DBS_TAR}" ]]; then
    nice pbzip2 -dc "${DBS_TAR}" | tar -C /vagrant -xf -
else
    # Temporarily disable GPG checking until release file signing is sorted out
    sudo debootstrap \
        --no-check-gpg \
        --include=systemd-container \
        --arch amd64 \
        "${DEBIAN_RELEASE}" \
        "${DBS_DIR}" \
        http://debmirror.cluster.earlham.edu
fi

for dir in dev proc sys boot/grub; do
    if [[ ! -d "${DBS_DIR}"/"${dir}" ]]; then
        /bin/mkdir -p "${DBS_DIR}"/"${dir}"
    fi
done

setup_virtual_mounts

for service in systemd-{networkd,resolved}; do 
    chroot "${DBS_DIR}" systemctl enable "${service}"
done

exit 0
